<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product Listing Generator</title>

  <style>
    :root{
      --bg0:#060812;
      --bg1:#0b1220;
      --panel: rgba(255,255,255,.04);
      --panel2: rgba(255,255,255,.02);
      --border: rgba(255,255,255,.10);
      --text:#e9eef8;
      --muted:#9fb0cc;
      --acc1:#5cc8ff;
      --acc2:#4be3b1;
      --bad:#ff6b88;
      --warn:#ffcc66;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(92,200,255,.22), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(75,227,177,.12), transparent 60%),
        radial-gradient(1200px 900px at 50% 120%, rgba(132,96,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width:1180px; margin:28px auto; padding:0 16px 40px; }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
      font-size:18px;
      margin:0;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    .brand .sub{ font-size:13px; color:var(--muted); margin:0; }

    .tabs{
      display:flex;
      gap:10px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18) inset;
    }
    .tab{
      color:var(--muted);
      text-decoration:none;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      transition:.15s ease;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .tab:hover{ color:var(--text); background: rgba(255,255,255,.04); }
    .tab.active{
      color:#06111a;
      background: linear-gradient(135deg, var(--acc1), var(--acc2));
      font-weight:900;
      box-shadow: 0 14px 40px rgba(92,200,255,.16);
    }

    .panel{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .top{
      padding:16px;
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    }

    .card{
      background: rgba(255,255,255,.02);
      border:1px solid var(--border);
      border-radius: var(--r);
      padding:14px;
      min-width:0;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .muted{ color:var(--muted); font-size:13px; }
    .row{ display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .col{ flex:1; min-width:220px; }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }

    select, textarea, button, input{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{ min-height: 92px; resize: vertical; }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .btn{
      border:0;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      padding:12px 14px;
      border-radius: 14px;
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.985); }
    .btn.primary{
      color:#06111a;
      background: linear-gradient(135deg, var(--acc1), var(--acc2));
      box-shadow: 0 18px 55px rgba(75,227,177,.12);
    }
    .btn.secondary{
      color:var(--text);
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      font-weight:700;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .drop{
      border:1.5px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.02);
      border-radius: var(--r);
      padding:14px;
      min-height: 220px;
      display:flex;
      flex-direction:column;
      gap:12px;
      justify-content:flex-start;
      align-items:stretch;
      transition:.15s ease;
    }
    .drop.drag{
      border-color: rgba(92,200,255,.75);
      box-shadow: 0 0 0 4px rgba(92,200,255,.15);
      background: rgba(92,200,255,.06);
    }
    .dropTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .dropTop .big{
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
    }
    .dropTop .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .pick{
      width:auto;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      user-select:none;
      transition:.12s ease;
    }
    .pick:hover{ filter: brightness(1.08); }
    .pick:disabled{ opacity:.55; cursor:not-allowed; }

    .thumbs{
      width:100%;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .thumb{
      position:relative;
      border-radius: 14px;
      border:1px solid var(--border);
      overflow:hidden;
      background: rgba(0,0,0,.15);
      aspect-ratio: 1 / 1;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.05) contrast(1.02);
    }
    .thumb .x{
      position:absolute;
      top:8px; right:8px;
      width:28px; height:28px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-weight:900;
      user-select:none;
    }
    .thumb .x:hover{ background: rgba(0,0,0,.5); }
    .meta{
      width:100%;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      align-items:center;
    }
    .meta b{ color:var(--text); }

    .bottom{
      padding:16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    .headrow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }

    .copy{
      width:auto;
      padding:8px 10px;
      font-size:12px;
      border-radius: 12px;
      cursor:pointer;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:var(--text);
      font-weight:800;
      user-select:none;
      transition:.12s ease;
    }
    .copy:hover{ filter: brightness(1.06); }
    .copy:disabled{ opacity:.55; cursor:not-allowed; }

    .block{
      border:1px solid var(--border);
      border-radius: 16px;
      padding:12px;
      background: rgba(0,0,0,.18);
      white-space:pre-wrap;
      word-break:break-word;
      font-size:13px;
      line-height:1.4;
      min-height: 56px;
    }

    details{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.02);
      overflow:hidden;
      margin-bottom:10px;
    }
    summary{
      cursor:pointer;
      padding:12px 12px;
      font-weight:900;
      list-style:none;
      user-select:none;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    summary::-webkit-details-marker{ display:none; }
    .pill{
      font-size:11px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    .inside{ padding:0 12px 12px; }

    .kvs{
      display:grid;
      grid-template-columns: 170px 1fr;
      gap:10px;
    }
    .kv{
      padding:8px 0;
      border-bottom:1px dashed rgba(255,255,255,.10);
    }
    .kvKey{ color: var(--muted); font-size:12px; }
    .kvVal{ color: var(--text); font-size:13px; }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      background: rgba(17,24,39,.95);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      color:var(--text);
      opacity:0;
      pointer-events:none;
      transition:.18s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      z-index: 10000;
    }
    .toast.show{ opacity:1; }

    .hidden{ display:none !important; }

    @media (max-width: 980px){
      .top{ grid-template-columns: 1fr; }
      .bottom{ grid-template-columns: 1fr; }
      .thumbs{ grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 520px){
      .thumbs{ grid-template-columns: repeat(2, 1fr); }
      .actions{ grid-template-columns: 1fr; }
      .col{ min-width: 100%; }
    }

    .overlay{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index: 9999;
      padding: 12px;
    }
    .loaderCard{
      width: min(620px, calc(100% - 24px));
      background: rgba(17,24,39,.88);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      padding: 16px;
      display:flex;
      align-items:center;
      gap: 14px;
    }
    .spinner{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.18);
      border-top-color: rgba(92,200,255,.95);
      animation: spin 0.9s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loaderText{ flex: 1; min-width: 0; }
    .loaderTitle{ font-weight: 900; letter-spacing: .2px; }
    .loaderSub{ color: var(--muted); font-size: 13px; margin-top: 2px; line-height: 1.35; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1 class="title">
          Product Listing Generator
          <span class="badge" id="modeBadge">OLX</span>
        </h1>
        <p class="sub">Photos → attributes → marketplace listing (OLX / Wildberries / Ozon)</p>
      </div>

      <nav class="tabs" aria-label="Marketplace tabs">
        <a class="tab" href="/olx" data-mode="olx">OLX</a>
        <a class="tab" href="/wb" data-mode="wildberries">Wildberries</a>
        <a class="tab" href="/ozon" data-mode="ozon">Ozon</a>
      </nav>
    </header>

    <section class="panel">
      <div class="top">
        <div class="card">
          <h3>Input <span class="pill" id="statePill">Ready</span></h3>

          <div class="row">
            <div class="col">
              <label for="lang">Output language</label>
              <select id="lang">
                <option value="ru">RU</option>
                <option value="kz">KZ</option>
                <option value="en">EN</option>
              </select>
            </div>

            <div class="col">
              <label for="hint">Notes (optional)</label>
              <textarea id="hint" placeholder="brand, model, size, condition, bundle..."></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnGen">Generate</button>
            <button class="btn secondary" id="btnClear">Clear</button>
          </div>

          <p class="muted" style="margin:10px 0 0 0;">
            Tip: use 3–8 photos (logo/label/packaging + overall view).
          </p>
        </div>

        <div class="card">
          <h3>Photos <span class="pill"><span id="count">0</span>/8</span></h3>

          <div id="drop" class="drop">
            <div class="dropTop">
              <div>
                <div class="big">Drop photos here</div>
                <div class="small">PNG/JPG/WebP • multiple at once • max 8</div>
              </div>
              <div>
                <input id="fileInput" type="file" accept="image/png,image/jpeg,image/webp" multiple class="hidden">
                <button class="pick" id="btnPick" type="button">Choose files</button>
              </div>
            </div>

            <div class="meta">
              <div>Selected: <b id="filesLabel">0</b></div>
              <div>Size: <b id="sizeLabel">0 B</b></div>
            </div>

            <div class="thumbs" id="thumbs"></div>
          </div>
        </div>
      </div>

      <div class="bottom">
        <div class="card">
          <div class="headrow">
            <h3 style="margin:0;">Universal</h3>
            <button class="copy" id="copyUniversal" type="button">Copy</button>
          </div>
          <div class="block" id="universalOut">{}</div>
        </div>

        <div class="card">
          <div class="headrow">
            <h3 style="margin:0;">Listing: <span id="listingTitle">OLX</span></h3>
            <button class="copy" id="copyListing" type="button">Copy</button>
          </div>

          <div id="listingOut">
            <div class="block">—</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <div class="overlay hidden" id="overlay">
    <div class="loaderCard">
      <div class="spinner"></div>
      <div class="loaderText">
        <div class="loaderTitle" id="loaderTitle">Generating…</div>
        <div class="loaderSub" id="loaderSub">Analyzing photos and extracting attributes</div>
      </div>
      <button class="copy" id="btnCancel" type="button">Cancel</button>
    </div>
  </div>

  <script>
    const state = {
      mode: "olx",
      files: [],
      result: null,
      loading: false,
      aborter: null,
      stepTimer: null,
      stepIndex: 0,
      steps: [
        "Analyzing photos and extracting attributes",
        "Building a universal product profile",
        "Generating OLX / WB / Ozon listing variants",
        "Checking missing/uncertain fields",
      ]
    };

    const $ = (id) => document.getElementById(id);

    function showToast(msg) {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2200);
    }

    function formatBytes(bytes) {
      const units = ["B","KB","MB","GB"];
      let i = 0, n = bytes;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
    }

    function routeToMode(pathname) {
      const p = (pathname || "/").toLowerCase();
      if (p === "/wb" || p === "/wildberries") return "wildberries";
      if (p === "/ozon") return "ozon";
      return "olx";
    }

    function modeToRoute(mode) {
      if (mode === "wildberries") return "/wb";
      if (mode === "ozon") return "/ozon";
      return "/olx";
    }

    function modeLabel(mode) {
      if (mode === "wildberries") return "Wildberries";
      if (mode === "ozon") return "Ozon";
      return "OLX";
    }

    function setLoading(on) {
      state.loading = on;

      $("overlay").classList.toggle("hidden", !on);
      $("statePill").textContent = on ? "Working…" : "Ready";

      $("btnGen").disabled = on;
      $("btnClear").disabled = on;
      $("btnPick").disabled = on;
      $("lang").disabled = on;
      $("hint").disabled = on;

      document.querySelectorAll(".thumb .x").forEach(el => el.style.pointerEvents = on ? "none" : "auto");

      if (on) {
        state.stepIndex = 0;
        $("loaderTitle").textContent = "Generating…";
        $("loaderSub").textContent = state.steps[state.stepIndex];

        clearInterval(state.stepTimer);
        state.stepTimer = setInterval(() => {
          state.stepIndex = (state.stepIndex + 1) % state.steps.length;
          $("loaderSub").textContent = state.steps[state.stepIndex];
        }, 1400);
      } else {
        clearInterval(state.stepTimer);
        state.stepTimer = null;
      }
    }

    function setMode(mode) {
      state.mode = mode;
      $("modeBadge").textContent = modeLabel(mode);
      $("listingTitle").textContent = modeLabel(mode);

      document.querySelectorAll(".tab").forEach(a => {
        a.classList.toggle("active", a.dataset.mode === mode);
      });

      renderOutputs();
    }

    function updateFilesUI() {
      const count = state.files.length;
      $("count").textContent = count;
      $("filesLabel").textContent = String(count);

      const totalBytes = state.files.reduce((s,f) => s + (f.size || 0), 0);
      $("sizeLabel").textContent = formatBytes(totalBytes);

      const thumbs = $("thumbs");
      thumbs.innerHTML = "";

      state.files.forEach((file, idx) => {
        const url = URL.createObjectURL(file);

        const div = document.createElement("div");
        div.className = "thumb";
        div.innerHTML = `
          <img src="${url}" alt="photo ${idx+1}">
          <div class="x" title="Remove">×</div>
        `;

        div.querySelector(".x").addEventListener("click", () => {
          if (state.loading) return;
          state.files.splice(idx, 1);
          updateFilesUI();
          renderOutputs();
        });

        div.querySelector("img").addEventListener("load", () => URL.revokeObjectURL(url));

        thumbs.appendChild(div);
      });
    }

    function addFiles(fileList) {
      const incoming = Array.from(fileList || []);
      if (!incoming.length) return;

      const images = incoming.filter(f => (f.type || "").startsWith("image/"));
      if (!images.length) {
        showToast("Please upload image files (PNG/JPG/WebP)");
        return;
      }

      const free = 8 - state.files.length;
      if (free <= 0) {
        showToast("You already selected 8 photos");
        return;
      }

      const toAdd = images.slice(0, free);
      state.files.push(...toAdd);

      if (images.length > free) showToast("Max 8 photos — extra files were ignored");
      updateFilesUI();
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderListingVariant(v) {
      if (!v) return `<div class="block">—</div>`;

      const bulletsCount = Array.isArray(v.bullets) ? v.bullets.length : 0;
      const keywordsCount = Array.isArray(v.keywords) ? v.keywords.length : 0;
      const todosCount = Array.isArray(v.compliance_todos) ? v.compliance_todos.length : 0;
      const unctCount = Array.isArray(v.uncertainty) ? v.uncertainty.length : 0;

      const bulletsText = (v.bullets || []).map(x => `• ${x}`).join("\n");
      const keywordsText = (v.keywords || []).join(", ");

      const attr = v.attributes && typeof v.attributes === "object" ? v.attributes : {};
      const attrKeys = Object.keys(attr);

      const attrsHtml = attrKeys.length
        ? `<div class="kvs">
            ${attrKeys.map(k => `
              <div class="kv kvKey">${escapeHtml(k)}</div>
              <div class="kv kvVal">${escapeHtml(String(attr[k]))}</div>
            `).join("")}
          </div>`
        : `<div class="muted">No attributes</div>`;

      const todosText = (v.compliance_todos || []).map(x => `• ${x}`).join("\n");
      const unctText = (v.uncertainty || []).map(x => `• ${x}`).join("\n");

      return `
        <details open>
          <summary>Title <span class="pill">1</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(v.title || "")}</div>
          </div>
        </details>

        <details>
          <summary>Bullets <span class="pill">${bulletsCount}</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(bulletsText || "")}</div>
          </div>
        </details>

        <details>
          <summary>Description <span class="pill">text</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(v.description || "")}</div>
          </div>
        </details>

        <details>
          <summary>Keywords <span class="pill">${keywordsCount}</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(keywordsText || "")}</div>
          </div>
        </details>

        <details>
          <summary>Attributes <span class="pill">${attrKeys.length}</span></summary>
          <div class="inside">${attrsHtml}</div>
        </details>

        <details>
          <summary>Compliance checks <span class="pill">${todosCount}</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(todosText || "")}</div>
          </div>
        </details>

        <details>
          <summary>Uncertainty <span class="pill">${unctCount}</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(unctText || "")}</div>
          </div>
        </details>
      `;
    }

    function renderOutputs() {
      const universal = state.result?.universal || {};
      $("universalOut").textContent = JSON.stringify(universal, null, 2);

      const listings = state.result?.listings || {};
      const v = listings[state.mode];
      $("listingOut").innerHTML = state.result ? renderListingVariant(v) : `<div class="block">—</div>`;
    }

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
        showToast("Copied");
      } catch {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showToast("Copied");
      }
    }

    async function generate() {
      if (state.loading) return;
      if (!state.files.length) {
        showToast("Add at least 1 photo");
        return;
      }

      setLoading(true);

      const fd = new FormData();
      fd.append("lang", $("lang").value);
      fd.append("hint", $("hint").value || "");
      state.files.forEach(f => fd.append("files", f, f.name));

      const controller = new AbortController();
      state.aborter = controller;

      try {
        const res = await fetch("/api/generate", {
          method: "POST",
          body: fd,
          signal: controller.signal
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch { data = { ok:false, error: text }; }

        if (!res.ok) {
          const msg = data?.error || data?.detail || `Request failed (${res.status})`;
          throw new Error(msg);
        }

        state.result = data;
        renderOutputs();
        showToast("Done");
      } catch (e) {
        if (e?.name === "AbortError") {
          showToast("Canceled");
        } else {
          showToast(e?.message || "Request error");
          console.error(e);
        }
      } finally {
        state.aborter = null;
        setLoading(false);
      }
    }

    function clearAll() {
      if (state.loading) return;
      state.files = [];
      state.result = null;
      $("hint").value = "";
      updateFilesUI();
      renderOutputs();
      showToast("Cleared");
    }

    function init() {
      setMode(routeToMode(location.pathname));

      document.querySelectorAll(".tab").forEach(a => {
        a.addEventListener("click", (ev) => {
          ev.preventDefault();
          const mode = a.dataset.mode;
          history.pushState({}, "", modeToRoute(mode));
          setMode(mode);
        });
      });

      window.addEventListener("popstate", () => {
        setMode(routeToMode(location.pathname));
      });

      $("btnPick").addEventListener("click", () => {
        if (state.loading) return;
        $("fileInput").click();
      });

      $("fileInput").addEventListener("change", (e) => {
        addFiles(e.target.files);
        e.target.value = "";
      });

      const drop = $("drop");
      drop.addEventListener("dragenter", (e) => { e.preventDefault(); if (!state.loading) drop.classList.add("drag"); });
      drop.addEventListener("dragover", (e) => { e.preventDefault(); if (!state.loading) drop.classList.add("drag"); });
      drop.addEventListener("dragleave", (e) => { e.preventDefault(); drop.classList.remove("drag"); });
      drop.addEventListener("drop", (e) => {
        e.preventDefault();
        drop.classList.remove("drag");
        if (state.loading) return;
        addFiles(e.dataTransfer.files);
      });

      $("btnGen").addEventListener("click", generate);
      $("btnClear").addEventListener("click", clearAll);

      $("btnCancel").addEventListener("click", () => {
        if (state.aborter) state.aborter.abort();
      });

      $("copyUniversal").addEventListener("click", () => {
        copyText($("universalOut").textContent || "{}");
      });

      $("copyListing").addEventListener("click", () => {
        const listings = state.result?.listings || {};
        const v = listings[state.mode] || {};
        copyText(JSON.stringify(v, null, 2));
      });

      updateFilesUI();
      renderOutputs();
    }

    init();
  </script>
</body>
</html>
