<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product Listing Generator</title>

  <style>
    :root{
      --bg0:#060812;
      --bg1:#0b1220;
      --panel: rgba(255,255,255,.04);
      --panel2: rgba(255,255,255,.02);
      --border: rgba(255,255,255,.10);
      --text:#e9eef8;
      --muted:#9fb0cc;
      --acc1:#5cc8ff;
      --acc2:#4be3b1;
      --bad:#ff6b88;
      --warn:#ffcc66;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r:18px;
    }

    /* Light theme */
    [data-theme="light"]{
      --bg0:#f5f7fa;
      --bg1:#ffffff;
      --panel: rgba(0,0,0,.03);
      --panel2: rgba(0,0,0,.02);
      --border: rgba(0,0,0,.10);
      --text:#1a202c;
      --muted:#64748b;
      --acc1:#0891b2;
      --acc2:#059669;
      --bad:#dc2626;
      --warn:#d97706;
      --shadow: 0 18px 55px rgba(0,0,0,.08);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(92,200,255,.22), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(75,227,177,.12), transparent 60%),
        radial-gradient(1200px 900px at 50% 120%, rgba(132,96,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      transition: background .3s ease, color .3s ease;
    }

    [data-theme="light"] body{
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(8,145,178,.08), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(5,150,105,.06), transparent 60%),
        radial-gradient(1200px 900px at 50% 120%, rgba(99,102,241,.05), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{ max-width:1180px; margin:28px auto; padding:0 16px 40px; }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
      font-size:18px;
      margin:0;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    [data-theme="light"] .badge{
      background: rgba(0,0,0,.03);
    }
    .brand .sub{ font-size:13px; color:var(--muted); margin:0; }

    .header-right{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .user-info{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:999px;
      font-size:13px;
    }
    [data-theme="light"] .user-info{
      background: rgba(0,0,0,.03);
    }
    .user-email{ color:var(--muted); cursor:pointer; transition:.12s ease; }
    .user-email:hover{ color:var(--acc1); }
    .logout-btn{
      background:none;
      border:none;
      color:var(--bad);
      cursor:pointer;
      font-size:12px;
      padding:4px 8px;
      border-radius:8px;
      transition:.12s ease;
    }
    .logout-btn:hover{ background: rgba(255,107,136,.1); }

    .tabs{
      display:flex;
      gap:10px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18) inset;
    }
    [data-theme="light"] .tabs{
      background: rgba(0,0,0,.03);
      box-shadow: 0 10px 30px rgba(0,0,0,.04) inset;
    }
    .tab{
      color:var(--muted);
      text-decoration:none;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      transition:.15s ease;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .tab:hover{ color:var(--text); background: rgba(255,255,255,.04); }
    [data-theme="light"] .tab:hover{ background: rgba(0,0,0,.04); }
    .tab.active{
      color:#ffffff;
      background: linear-gradient(135deg, var(--acc1), var(--acc2));
      font-weight:900;
      box-shadow: 0 14px 40px rgba(92,200,255,.16);
    }
    [data-theme="light"] .tab.active{
      color:#ffffff;
      box-shadow: 0 14px 40px rgba(8,145,178,.2);
    }

    .panel{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    [data-theme="light"] .panel{
      background: rgba(255,255,255,.7);
    }

    .top{
      padding:16px;
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    }
    [data-theme="light"] .top{
      background: linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0));
    }

    .card{
      background: rgba(255,255,255,.02);
      border:1px solid var(--border);
      border-radius: var(--r);
      padding:14px;
      min-width:0;
    }
    [data-theme="light"] .card{
      background: rgba(255,255,255,.5);
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .muted{ color:var(--muted); font-size:13px; }
    .row{ display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .col{ flex:1; min-width:220px; }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }

    select, textarea, button, input{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{ min-height: 92px; resize: vertical; }
    [data-theme="light"] select,
    [data-theme="light"] textarea,
    [data-theme="light"] input{
      background: rgba(255,255,255,.8);
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .btn{
      border:0;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      padding:12px 14px;
      border-radius: 14px;
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.985); }
    .btn.primary{
      color:#ffffff;
      background: linear-gradient(135deg, var(--acc1), var(--acc2));
      box-shadow: 0 18px 55px rgba(75,227,177,.12);
    }
    [data-theme="light"] .btn.primary{
      box-shadow: 0 18px 55px rgba(5,150,105,.15);
    }
    .btn.secondary{
      color:var(--text);
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      font-weight:700;
    }
    [data-theme="light"] .btn.secondary{
      background: rgba(0,0,0,.04);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .drop{
      border:1.5px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.02);
      border-radius: var(--r);
      padding:14px;
      min-height: 220px;
      display:flex;
      flex-direction:column;
      gap:12px;
      justify-content:flex-start;
      align-items:stretch;
      transition:.15s ease;
    }
    [data-theme="light"] .drop{
      border-color: rgba(0,0,0,.18);
      background: rgba(0,0,0,.02);
    }
    .drop.drag{
      border-color: rgba(92,200,255,.75);
      box-shadow: 0 0 0 4px rgba(92,200,255,.15);
      background: rgba(92,200,255,.06);
    }
    .dropTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .dropTop .big{
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
    }
    .dropTop .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .pick{
      width:auto;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      user-select:none;
      transition:.12s ease;
    }
    .pick:hover{ filter: brightness(1.08); }
    .pick:disabled{ opacity:.55; cursor:not-allowed; }
    [data-theme="light"] .pick{
      background: rgba(0,0,0,.04);
    }

    .thumbs{
      width:100%;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .thumb{
      position:relative;
      border-radius: 14px;
      border:1px solid var(--border);
      overflow:hidden;
      background: rgba(0,0,0,.15);
      aspect-ratio: 1 / 1;
    }
    [data-theme="light"] .thumb{
      background: rgba(0,0,0,.05);
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.05) contrast(1.02);
    }
    .thumb .x{
      position:absolute;
      top:8px; right:8px;
      width:28px; height:28px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-weight:900;
      user-select:none;
    }
    .thumb .x:hover{ background: rgba(0,0,0,.5); }
    .meta{
      width:100%;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      align-items:center;
    }
    .meta b{ color:var(--text); }

    .bottom{
      padding:16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    .headrow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }

    .copy{
      width:auto;
      padding:8px 10px;
      font-size:12px;
      border-radius: 12px;
      cursor:pointer;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color:var(--text);
      font-weight:800;
      user-select:none;
      transition:.12s ease;
    }
    .copy:hover{ filter: brightness(1.06); }
    .copy:disabled{ opacity:.55; cursor:not-allowed; }
    [data-theme="light"] .copy{
      background: rgba(0,0,0,.04);
    }

    .block{
      border:1px solid var(--border);
      border-radius: 16px;
      padding:12px;
      background: rgba(0,0,0,.18);
      white-space:pre-wrap;
      word-break:break-word;
      font-size:13px;
      line-height:1.4;
      min-height: 56px;
    }
    [data-theme="light"] .block{
      background: rgba(0,0,0,.04);
    }

    details{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.02);
      overflow:hidden;
      margin-bottom:10px;
    }
    [data-theme="light"] details{
      background: rgba(0,0,0,.02);
    }
    summary{
      cursor:pointer;
      padding:12px 12px;
      font-weight:900;
      list-style:none;
      user-select:none;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    summary::-webkit-details-marker{ display:none; }
    .pill{
      font-size:11px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    [data-theme="light"] .pill{
      background: rgba(0,0,0,.03);
    }
    .inside{ padding:0 12px 12px; }

    .kvs{
      display:grid;
      grid-template-columns: 170px 1fr;
      gap:10px;
    }
    .kv{
      padding:8px 0;
      border-bottom:1px dashed rgba(255,255,255,.10);
    }
    [data-theme="light"] .kv{
      border-bottom-color: rgba(0,0,0,.10);
    }
    .kvKey{ color: var(--muted); font-size:12px; }
    .kvVal{ color: var(--text); font-size:13px; }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      background: rgba(17,24,39,.95);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      color:var(--text);
      opacity:0;
      pointer-events:none;
      transition:.18s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      z-index: 10000;
    }
    .toast.show{ opacity:1; }
    [data-theme="light"] .toast{
      background: rgba(255,255,255,.98);
      box-shadow: 0 20px 60px rgba(0,0,0,.12);
    }

    .hidden{ display:none !important; }

    @media (max-width: 980px){
      .top{ grid-template-columns: 1fr; }
      .bottom{ grid-template-columns: 1fr; }
      .thumbs{ grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 520px){
      .thumbs{ grid-template-columns: repeat(2, 1fr); }
      .actions{ grid-template-columns: 1fr; }
      .col{ min-width: 100%; }
    }

    .overlay{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index: 9999;
      padding: 12px;
    }
    [data-theme="light"] .overlay{
      background: rgba(0,0,0,.35);
    }
    .loaderCard{
      width: min(620px, calc(100% - 24px));
      background: rgba(17,24,39,.88);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      padding: 16px;
      display:flex;
      align-items:center;
      gap: 14px;
    }
    [data-theme="light"] .loaderCard{
      background: rgba(255,255,255,.95);
      box-shadow: 0 25px 80px rgba(0,0,0,.15);
    }
    .spinner{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.18);
      border-top-color: rgba(92,200,255,.95);
      animation: spin 0.9s linear infinite;
      flex: 0 0 auto;
    }
    [data-theme="light"] .spinner{
      border-color: rgba(0,0,0,.1);
      border-top-color: var(--acc1);
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loaderText{ flex: 1; min-width: 0; }
    .loaderTitle{ font-weight: 900; letter-spacing: .2px; }
    .loaderSub{ color: var(--muted); font-size: 13px; margin-top: 2px; line-height: 1.35; }

    /* Auth Pages */
    .auth-page{
      max-width:400px;
      margin:80px auto;
      padding:0 16px;
    }
    .auth-card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: var(--r);
      padding:24px;
      box-shadow: var(--shadow);
    }
    [data-theme="light"] .auth-card{
      background: rgba(255,255,255,.8);
    }
    .auth-card h2{
      margin:0 0 20px 0;
      font-size:22px;
      text-align:center;
    }
    .auth-card .form-group{
      margin-bottom:16px;
    }
    .auth-card .form-group label{
      margin-bottom:6px;
    }
    .auth-card .error-msg{
      color:var(--bad);
      font-size:13px;
      margin-top:8px;
      text-align:center;
    }
    .auth-card .link-row{
      text-align:center;
      margin-top:16px;
      font-size:13px;
      color:var(--muted);
    }
    .auth-card .link-row a{
      color:var(--acc1);
      text-decoration:none;
    }
    .auth-card .link-row a:hover{
      text-decoration:underline;
    }

    /* Dashboard */
    .dashboard-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    .dashboard-header h2{
      margin:0;
      font-size:22px;
    }
    .stats-row{
      display:flex;
      gap:16px;
      margin-bottom:20px;
    }
    .stat-card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: 14px;
      padding:16px 20px;
      flex:1;
      min-width:120px;
    }
    [data-theme="light"] .stat-card{
      background: rgba(255,255,255,.7);
    }
    .stat-card .stat-value{
      font-size:28px;
      font-weight:900;
      color:var(--acc1);
    }
    .stat-card .stat-label{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .history-list{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .history-item{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: 14px;
      padding:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      cursor:pointer;
      transition:.12s ease;
    }
    .history-item:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.15);
    }
    [data-theme="light"] .history-item{
      background: rgba(255,255,255,.7);
    }
    [data-theme="light"] .history-item:hover{
      background: rgba(255,255,255,.9);
      border-color: rgba(0,0,0,.15);
    }
    .history-item-info{
      flex:1;
      min-width:0;
    }
    .history-item-title{
      font-weight:700;
      font-size:15px;
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .history-item-meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .history-item-actions{
      display:flex;
      gap:8px;
    }
    .history-item-actions button{
      width:auto;
      padding:8px 12px;
      font-size:12px;
    }
    .pagination{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:12px;
      margin-top:20px;
    }
    .pagination button{
      width:auto;
      padding:8px 16px;
    }
    .pagination .page-info{
      font-size:13px;
      color:var(--muted);
    }
    .empty-state{
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
    }
    .empty-state p{
      margin:0 0 16px 0;
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      z-index:10000;
      padding:16px;
    }
    .modal-content{
      width:min(900px, calc(100% - 32px));
      max-height:calc(100vh - 64px);
      background: rgba(17,24,39,.95);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      display:flex;
      flex-direction:column;
    }
    [data-theme="light"] .modal-content{
      background: rgba(255,255,255,.98);
      box-shadow: 0 25px 80px rgba(0,0,0,.15);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px;
      border-bottom:1px solid var(--border);
    }
    .modal-header h3{
      margin:0;
      font-size:16px;
    }
    .modal-close{
      background:none;
      border:none;
      color:var(--muted);
      cursor:pointer;
      font-size:20px;
      padding:4px 8px;
      border-radius:8px;
      transition:.12s ease;
    }
    .modal-close:hover{
      color:var(--text);
      background: rgba(255,255,255,.05);
    }
    .modal-body{
      flex:1;
      overflow-y:auto;
      padding:16px;
    }

    /* Theme Toggle */
    .theme-toggle{
      width:40px;
      height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:.15s ease;
      flex-shrink:0;
    }
    .theme-toggle:hover{
      color:var(--text);
      background: rgba(255,255,255,.06);
    }
    [data-theme="light"] .theme-toggle{
      background: rgba(0,0,0,.03);
    }
    [data-theme="light"] .theme-toggle:hover{
      background: rgba(0,0,0,.06);
    }
    .theme-toggle svg{
      width:20px;
      height:20px;
    }
    .theme-toggle .icon-sun{ display:none; }
    .theme-toggle .icon-moon{ display:block; }
    [data-theme="light"] .theme-toggle .icon-sun{ display:block; }
    [data-theme="light"] .theme-toggle .icon-moon{ display:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Header -->
    <header id="mainHeader">
      <div class="brand">
        <h1 class="title">
          Product Listing Generator
          <span class="badge" id="modeBadge">OLX</span>
        </h1>
        <p class="sub">Photos to marketplace listing (OLX / Wildberries / Ozon)</p>
      </div>

      <div class="header-right">
        <nav class="tabs" aria-label="Marketplace tabs" id="marketplaceTabs">
          <a class="tab" href="/olx" data-mode="olx">OLX</a>
          <a class="tab" href="/wb" data-mode="wildberries">Wildberries</a>
          <a class="tab" href="/ozon" data-mode="ozon">Ozon</a>
        </nav>

        <button class="theme-toggle" id="themeToggle" title="Toggle theme">
          <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>

        <div class="user-info hidden" id="userInfo">
          <span class="user-email" id="userEmail"></span>
          <button class="logout-btn" id="btnLogout">Logout</button>
        </div>

        <div id="authLinks">
          <a class="tab" href="/login" id="loginLink">Login</a>
        </div>
      </div>
    </header>

    <!-- Login Page -->
    <div class="auth-page hidden" id="loginPage">
      <div class="auth-card">
        <h2>Login</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" required placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input type="password" id="loginPassword" required placeholder="Your password">
          </div>
          <div class="error-msg hidden" id="loginError"></div>
          <button type="submit" class="btn primary" id="loginSubmit">Login</button>
        </form>
        <div class="link-row">
          Don't have an account? <a href="/register">Register</a>
        </div>
      </div>
    </div>

    <!-- Register Page -->
    <div class="auth-page hidden" id="registerPage">
      <div class="auth-card">
        <h2>Create Account</h2>
        <form id="registerForm">
          <div class="form-group">
            <label for="registerName">Full Name (optional)</label>
            <input type="text" id="registerName" placeholder="John Doe">
          </div>
          <div class="form-group">
            <label for="registerEmail">Email</label>
            <input type="email" id="registerEmail" required placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label for="registerPassword">Password</label>
            <input type="password" id="registerPassword" required minlength="6" placeholder="Min 6 characters">
          </div>
          <div class="form-group">
            <label for="registerConfirm">Confirm Password</label>
            <input type="password" id="registerConfirm" required placeholder="Repeat password">
          </div>
          <div class="error-msg hidden" id="registerError"></div>
          <button type="submit" class="btn primary" id="registerSubmit">Create Account</button>
        </form>
        <div class="link-row">
          Already have an account? <a href="/login">Login</a>
        </div>
      </div>
    </div>

    <!-- Dashboard Page -->
    <div class="hidden" id="dashboardPage">
      <div class="dashboard-header">
        <h2>Generation History</h2>
        <button class="btn primary" id="btnNewGeneration">New Generation</button>
      </div>

      <div class="stats-row" id="statsRow">
        <div class="stat-card">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">Total Generations</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statThisMonth">0</div>
          <div class="stat-label">This Month</div>
        </div>
      </div>

      <div id="historyContainer">
        <div class="history-list" id="historyList"></div>
        <div class="pagination hidden" id="pagination">
          <button class="btn secondary" id="btnPrevPage">Previous</button>
          <span class="page-info" id="pageInfo">Page 1 of 1</span>
          <button class="btn secondary" id="btnNextPage">Next</button>
        </div>
      </div>
    </div>

    <!-- Main Generator Panel -->
    <section class="panel hidden" id="generatorPanel">
      <div class="top">
        <div class="card">
          <h3>Input <span class="pill" id="statePill">Ready</span></h3>

          <div class="row">
            <div class="col">
              <label for="lang">Output language</label>
              <select id="lang">
                <option value="ru">RU</option>
                <option value="kz">KZ</option>
                <option value="en">EN</option>
              </select>
            </div>

            <div class="col">
              <label for="hint">Notes (optional)</label>
              <textarea id="hint" placeholder="brand, model, size, condition, bundle..."></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnGen">Generate</button>
            <button class="btn secondary" id="btnClear">Clear</button>
          </div>

          <p class="muted" style="margin:10px 0 0 0;">
            Tip: use 3-8 photos (logo/label/packaging + overall view).
          </p>
        </div>

        <div class="card">
          <h3>Photos <span class="pill"><span id="count">0</span>/8</span></h3>

          <div id="drop" class="drop">
            <div class="dropTop">
              <div>
                <div class="big">Drop photos here</div>
                <div class="small">PNG/JPG/WebP - multiple at once - max 8</div>
              </div>
              <div>
                <input id="fileInput" type="file" accept="image/png,image/jpeg,image/webp" multiple class="hidden">
                <button class="pick" id="btnPick" type="button">Choose files</button>
              </div>
            </div>

            <div class="meta">
              <div>Selected: <b id="filesLabel">0</b></div>
              <div>Size: <b id="sizeLabel">0 B</b></div>
            </div>

            <div class="thumbs" id="thumbs"></div>
          </div>
        </div>
      </div>

      <div class="bottom">
        <div class="card">
          <div class="headrow">
            <h3 style="margin:0;">Universal</h3>
            <button class="copy" id="copyUniversal" type="button">Copy</button>
          </div>
          <div class="block" id="universalOut">{}</div>
        </div>

        <div class="card">
          <div class="headrow">
            <h3 style="margin:0;">Listing: <span id="listingTitle">OLX</span></h3>
            <button class="copy" id="copyListing" type="button">Copy</button>
          </div>

          <div id="listingOut">
            <div class="block">-</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <div class="overlay hidden" id="overlay">
    <div class="loaderCard">
      <div class="spinner"></div>
      <div class="loaderText">
        <div class="loaderTitle" id="loaderTitle">Generating...</div>
        <div class="loaderSub" id="loaderSub">Analyzing photos and extracting attributes</div>
      </div>
      <button class="copy" id="btnCancel" type="button">Cancel</button>
    </div>
  </div>

  <!-- History Detail Modal -->
  <div class="modal hidden" id="historyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Generation Details</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // --- Theme Management ---
    const theme = {
      key: "theme",

      get() {
        return localStorage.getItem(this.key) || "dark";
      },

      set(value) {
        localStorage.setItem(this.key, value);
        this.apply(value);
      },

      apply(value) {
        if (value === "light") {
          document.documentElement.setAttribute("data-theme", "light");
        } else {
          document.documentElement.removeAttribute("data-theme");
        }
      },

      toggle() {
        const current = this.get();
        const next = current === "light" ? "dark" : "light";
        this.set(next);
      },

      init() {
        this.apply(this.get());
      }
    };

    // Initialize theme immediately to prevent flash
    theme.init();

    // --- Auth State ---
    const auth = {
      token: localStorage.getItem("token"),
      user: null,

      isLoggedIn() {
        return !!this.token;
      },

      setToken(token) {
        this.token = token;
        if (token) {
          localStorage.setItem("token", token);
        } else {
          localStorage.removeItem("token");
        }
      },

      logout() {
        this.token = null;
        this.user = null;
        localStorage.removeItem("token");
        // Clear all cached user data to prevent data leaking between users
        clearUserState();
        navigateTo("/login");
      },

      async fetch(url, options = {}) {
        const headers = options.headers || {};
        if (this.token) {
          headers["Authorization"] = `Bearer ${this.token}`;
        }
        const res = await fetch(url, { ...options, headers });
        if (res.status === 401) {
          this.logout();
          throw new Error("Session expired");
        }
        return res;
      },

      async fetchMe() {
        if (!this.token) return null;
        try {
          const res = await this.fetch("/api/auth/me");
          if (res.ok) {
            this.user = await res.json();
            return this.user;
          }
        } catch {
          // Ignore
        }
        this.setToken(null);
        return null;
      }
    };

    // --- App State ---
    const state = {
      mode: "olx",
      files: [],
      result: null,
      loading: false,
      aborter: null,
      stepTimer: null,
      stepIndex: 0,
      steps: [
        "Analyzing photos and extracting attributes",
        "Building a universal product profile",
        "Generating OLX / WB / Ozon listing variants",
        "Checking missing/uncertain fields",
      ],
      // Dashboard state
      historyPage: 1,
      historyLimit: 10,
      historyTotal: 0,
      historyItems: [],
    };

    const $ = (id) => document.getElementById(id);

    // Clear all user-specific state (call on logout and before new login)
    function clearUserState() {
      state.files = [];
      state.result = null;
      state.historyPage = 1;
      state.historyTotal = 0;
      state.historyItems = [];
      // Clear UI elements
      const hintEl = $("hint");
      if (hintEl) hintEl.value = "";
      const thumbsEl = $("thumbs");
      if (thumbsEl) thumbsEl.innerHTML = "";
      const universalOut = $("universalOut");
      if (universalOut) universalOut.textContent = "{}";
      const listingOut = $("listingOut");
      if (listingOut) listingOut.innerHTML = '<div class="block">-</div>';
    }

    // --- Navigation ---
    function getPageFromPath(pathname) {
      const p = (pathname || "/").toLowerCase();
      if (p === "/login") return "login";
      if (p === "/register") return "register";
      if (p === "/dashboard") return "dashboard";
      return "generator";
    }

    function routeToMode(pathname) {
      const p = (pathname || "/").toLowerCase();
      if (p === "/wb" || p === "/wildberries") return "wildberries";
      if (p === "/ozon") return "ozon";
      return "olx";
    }

    function modeToRoute(mode) {
      if (mode === "wildberries") return "/wb";
      if (mode === "ozon") return "/ozon";
      return "/olx";
    }

    function modeLabel(mode) {
      if (mode === "wildberries") return "Wildberries";
      if (mode === "ozon") return "Ozon";
      return "OLX";
    }

    function navigateTo(path) {
      history.pushState({}, "", path);
      renderPage();
    }

    function renderPage() {
      const page = getPageFromPath(location.pathname);

      // Hide all pages
      $("loginPage").classList.add("hidden");
      $("registerPage").classList.add("hidden");
      $("dashboardPage").classList.add("hidden");
      $("generatorPanel").classList.add("hidden");
      $("marketplaceTabs").classList.add("hidden");
      $("modeBadge").classList.add("hidden");

      // Update auth UI
      if (auth.isLoggedIn() && auth.user) {
        $("userInfo").classList.remove("hidden");
        $("authLinks").classList.add("hidden");
        $("userEmail").textContent = auth.user.email;
      } else {
        $("userInfo").classList.add("hidden");
        $("authLinks").classList.remove("hidden");
      }

      // Show appropriate page
      if (page === "login") {
        if (auth.isLoggedIn()) {
          navigateTo("/dashboard");
          return;
        }
        $("loginPage").classList.remove("hidden");
      } else if (page === "register") {
        if (auth.isLoggedIn()) {
          navigateTo("/dashboard");
          return;
        }
        $("registerPage").classList.remove("hidden");
      } else if (page === "dashboard") {
        if (!auth.isLoggedIn()) {
          navigateTo("/login");
          return;
        }
        $("dashboardPage").classList.remove("hidden");
        loadHistory();
      } else {
        // Generator page
        $("generatorPanel").classList.remove("hidden");
        $("marketplaceTabs").classList.remove("hidden");
        $("modeBadge").classList.remove("hidden");
        setMode(routeToMode(location.pathname));
      }
    }

    // --- Utilities ---
    function showToast(msg) {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2200);
    }

    function formatBytes(bytes) {
      const units = ["B","KB","MB","GB"];
      let i = 0, n = bytes;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString() + " " + d.toLocaleTimeString([], {hour: "2-digit", minute: "2-digit"});
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // --- Auth Functions ---
    async function handleLogin(e) {
      e.preventDefault();
      const email = $("loginEmail").value;
      const password = $("loginPassword").value;
      const errorEl = $("loginError");
      const btn = $("loginSubmit");

      errorEl.classList.add("hidden");
      btn.disabled = true;
      btn.textContent = "Logging in...";

      try {
        const res = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || data.detail || "Login failed");
        }

        // Clear any cached state from previous user before setting new user
        clearUserState();
        auth.setToken(data.access_token);
        await auth.fetchMe();
        showToast("Welcome back!");
        navigateTo("/dashboard");
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.remove("hidden");
      } finally {
        btn.disabled = false;
        btn.textContent = "Login";
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const fullName = $("registerName").value;
      const email = $("registerEmail").value;
      const password = $("registerPassword").value;
      const confirm = $("registerConfirm").value;
      const errorEl = $("registerError");
      const btn = $("registerSubmit");

      errorEl.classList.add("hidden");

      if (password !== confirm) {
        errorEl.textContent = "Passwords do not match";
        errorEl.classList.remove("hidden");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Creating account...";

      try {
        const res = await fetch("/api/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password, full_name: fullName || null })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || data.detail || "Registration failed");
        }

        // Clear any cached state from previous user before setting new user
        clearUserState();
        auth.setToken(data.access_token);
        await auth.fetchMe();
        showToast("Account created!");
        navigateTo("/dashboard");
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.remove("hidden");
      } finally {
        btn.disabled = false;
        btn.textContent = "Create Account";
      }
    }

    // --- Dashboard Functions ---
    async function loadHistory() {
      try {
        const res = await auth.fetch(`/api/history?page=${state.historyPage}&limit=${state.historyLimit}`);
        if (!res.ok) throw new Error("Failed to load history");

        const data = await res.json();
        state.historyItems = data.items;
        state.historyTotal = data.total;

        renderHistory();
        renderStats();
      } catch (err) {
        showToast(err.message);
      }
    }

    function renderHistory() {
      const container = $("historyList");
      const pagination = $("pagination");

      if (state.historyItems.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>No generations yet. Create your first listing!</p>
            <button class="btn primary" onclick="navigateTo('/olx')">New Generation</button>
          </div>
        `;
        pagination.classList.add("hidden");
        return;
      }

      container.innerHTML = state.historyItems.map(item => `
        <div class="history-item" data-id="${item.id}">
          <div class="history-item-info">
            <div class="history-item-title">${escapeHtml(item.product_type || "Product")}${item.brand ? ` - ${escapeHtml(item.brand)}` : ""}</div>
            <div class="history-item-meta">
              <span>${formatDate(item.created_at)}</span>
              <span>${item.image_count} image${item.image_count !== 1 ? "s" : ""}</span>
              <span>${item.lang.toUpperCase()}</span>
              ${item.generation_time_ms ? `<span>${(item.generation_time_ms / 1000).toFixed(1)}s</span>` : ""}
            </div>
          </div>
          <div class="history-item-actions">
            <button class="btn secondary view-btn" data-id="${item.id}">View</button>
            <button class="btn secondary delete-btn" data-id="${item.id}">Delete</button>
          </div>
        </div>
      `).join("");

      // Add event listeners
      container.querySelectorAll(".view-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          viewHistoryItem(btn.dataset.id);
        });
      });

      container.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteHistoryItem(btn.dataset.id);
        });
      });

      container.querySelectorAll(".history-item").forEach(item => {
        item.addEventListener("click", () => {
          viewHistoryItem(item.dataset.id);
        });
      });

      // Pagination
      const totalPages = Math.ceil(state.historyTotal / state.historyLimit);
      if (totalPages > 1) {
        pagination.classList.remove("hidden");
        $("pageInfo").textContent = `Page ${state.historyPage} of ${totalPages}`;
        $("btnPrevPage").disabled = state.historyPage <= 1;
        $("btnNextPage").disabled = state.historyPage >= totalPages;
      } else {
        pagination.classList.add("hidden");
      }
    }

    function renderStats() {
      $("statTotal").textContent = state.historyTotal;

      // Count this month
      const now = new Date();
      const thisMonth = state.historyItems.filter(item => {
        const d = new Date(item.created_at);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      }).length;
      $("statThisMonth").textContent = thisMonth;
    }

    async function viewHistoryItem(id) {
      try {
        const res = await auth.fetch(`/api/history/${id}`);
        if (!res.ok) throw new Error("Failed to load generation");

        const data = await res.json();
        showHistoryModal(data);
      } catch (err) {
        showToast(err.message);
      }
    }

    async function deleteHistoryItem(id) {
      if (!confirm("Delete this generation from history?")) return;

      try {
        const res = await auth.fetch(`/api/history/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Failed to delete");

        showToast("Deleted");
        loadHistory();
      } catch (err) {
        showToast(err.message);
      }
    }

    function showHistoryModal(data) {
      const modal = $("historyModal");
      const body = $("modalBody");

      $("modalTitle").textContent = `${data.product_type || "Product"}${data.brand ? ` - ${data.brand}` : ""}`;

      const result = data.result_json;
      const universal = result?.universal || {};
      const listings = result?.listings || {};

      body.innerHTML = `
        <div style="margin-bottom:16px;">
          <div class="muted" style="margin-bottom:8px;">Generated: ${formatDate(data.created_at)} | ${data.image_count} images | ${data.lang.toUpperCase()}</div>
          ${data.hint ? `<div class="muted">Hint: ${escapeHtml(data.hint)}</div>` : ""}
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="card">
            <h3 style="margin:0 0 10px 0;">Universal</h3>
            <div class="block">${escapeHtml(JSON.stringify(universal, null, 2))}</div>
          </div>

          <div class="card">
            <h3 style="margin:0 0 10px 0;">OLX</h3>
            ${renderListingVariant(listings.olx)}
          </div>

          <div class="card">
            <h3 style="margin:0 0 10px 0;">Wildberries</h3>
            ${renderListingVariant(listings.wildberries)}
          </div>

          <div class="card">
            <h3 style="margin:0 0 10px 0;">Ozon</h3>
            ${renderListingVariant(listings.ozon)}
          </div>
        </div>
      `;

      modal.classList.remove("hidden");
    }

    function closeHistoryModal() {
      $("historyModal").classList.add("hidden");
    }

    // --- Generator Functions ---
    function setLoading(on) {
      state.loading = on;

      $("overlay").classList.toggle("hidden", !on);
      $("statePill").textContent = on ? "Working..." : "Ready";

      $("btnGen").disabled = on;
      $("btnClear").disabled = on;
      $("btnPick").disabled = on;
      $("lang").disabled = on;
      $("hint").disabled = on;

      document.querySelectorAll(".thumb .x").forEach(el => el.style.pointerEvents = on ? "none" : "auto");

      if (on) {
        state.stepIndex = 0;
        $("loaderTitle").textContent = "Generating...";
        $("loaderSub").textContent = state.steps[state.stepIndex];

        clearInterval(state.stepTimer);
        state.stepTimer = setInterval(() => {
          state.stepIndex = (state.stepIndex + 1) % state.steps.length;
          $("loaderSub").textContent = state.steps[state.stepIndex];
        }, 1400);
      } else {
        clearInterval(state.stepTimer);
        state.stepTimer = null;
      }
    }

    function setMode(mode) {
      state.mode = mode;
      $("modeBadge").textContent = modeLabel(mode);
      $("listingTitle").textContent = modeLabel(mode);

      document.querySelectorAll("#marketplaceTabs .tab").forEach(a => {
        a.classList.toggle("active", a.dataset.mode === mode);
      });

      renderOutputs();
    }

    function updateFilesUI() {
      const count = state.files.length;
      $("count").textContent = count;
      $("filesLabel").textContent = String(count);

      const totalBytes = state.files.reduce((s,f) => s + (f.size || 0), 0);
      $("sizeLabel").textContent = formatBytes(totalBytes);

      const thumbs = $("thumbs");
      thumbs.innerHTML = "";

      state.files.forEach((file, idx) => {
        const url = URL.createObjectURL(file);

        const div = document.createElement("div");
        div.className = "thumb";
        div.innerHTML = `
          <img src="${url}" alt="photo ${idx+1}">
          <div class="x" title="Remove">x</div>
        `;

        div.querySelector(".x").addEventListener("click", () => {
          if (state.loading) return;
          state.files.splice(idx, 1);
          updateFilesUI();
          renderOutputs();
        });

        div.querySelector("img").addEventListener("load", () => URL.revokeObjectURL(url));

        thumbs.appendChild(div);
      });
    }

    function addFiles(fileList) {
      const incoming = Array.from(fileList || []);
      if (!incoming.length) return;

      const images = incoming.filter(f => (f.type || "").startsWith("image/"));
      if (!images.length) {
        showToast("Please upload image files (PNG/JPG/WebP)");
        return;
      }

      const free = 8 - state.files.length;
      if (free <= 0) {
        showToast("You already selected 8 photos");
        return;
      }

      const toAdd = images.slice(0, free);
      state.files.push(...toAdd);

      if (images.length > free) showToast("Max 8 photos - extra files were ignored");
      updateFilesUI();
    }

    function renderListingVariant(v) {
      if (!v) return `<div class="block">-</div>`;

      const bulletsCount = Array.isArray(v.bullets) ? v.bullets.length : 0;
      const keywordsCount = Array.isArray(v.keywords) ? v.keywords.length : 0;
      const todosCount = Array.isArray(v.compliance_todos) ? v.compliance_todos.length : 0;
      const unctCount = Array.isArray(v.uncertainty) ? v.uncertainty.length : 0;

      const bulletsText = (v.bullets || []).map(x => `- ${x}`).join("\n");
      const keywordsText = (v.keywords || []).join(", ");

      const attr = v.attributes && typeof v.attributes === "object" ? v.attributes : {};
      const attrKeys = Object.keys(attr);

      const attrsHtml = attrKeys.length
        ? `<div class="kvs">
            ${attrKeys.map(k => `
              <div class="kv kvKey">${escapeHtml(k)}</div>
              <div class="kv kvVal">${escapeHtml(String(attr[k]))}</div>
            `).join("")}
          </div>`
        : `<div class="muted">No attributes</div>`;

      const todosText = (v.compliance_todos || []).map(x => `- ${x}`).join("\n");
      const unctText = (v.uncertainty || []).map(x => `- ${x}`).join("\n");

      return `
        <details open>
          <summary>Title <span class="pill">1</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(v.title || "")}</div>
          </div>
        </details>

        <details>
          <summary>Bullets <span class="pill">${bulletsCount}</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(bulletsText || "")}</div>
          </div>
        </details>

        <details>
          <summary>Description <span class="pill">text</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(v.description || "")}</div>
          </div>
        </details>

        <details>
          <summary>Keywords <span class="pill">${keywordsCount}</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(keywordsText || "")}</div>
          </div>
        </details>

        <details>
          <summary>Attributes <span class="pill">${attrKeys.length}</span></summary>
          <div class="inside">${attrsHtml}</div>
        </details>

        <details>
          <summary>Compliance checks <span class="pill">${todosCount}</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(todosText || "")}</div>
          </div>
        </details>

        <details>
          <summary>Uncertainty <span class="pill">${unctCount}</span></summary>
          <div class="inside">
            <div class="block">${escapeHtml(unctText || "")}</div>
          </div>
        </details>
      `;
    }

    function renderOutputs() {
      const universal = state.result?.universal || {};
      $("universalOut").textContent = JSON.stringify(universal, null, 2);

      const listings = state.result?.listings || {};
      const v = listings[state.mode];
      $("listingOut").innerHTML = state.result ? renderListingVariant(v) : `<div class="block">-</div>`;
    }

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
        showToast("Copied");
      } catch {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showToast("Copied");
      }
    }

    async function generate() {
      if (state.loading) return;
      if (!state.files.length) {
        showToast("Add at least 1 photo");
        return;
      }

      setLoading(true);

      const fd = new FormData();
      fd.append("lang", $("lang").value);
      fd.append("hint", $("hint").value || "");
      state.files.forEach(f => fd.append("files", f, f.name));

      const controller = new AbortController();
      state.aborter = controller;

      try {
        const fetchOptions = {
          method: "POST",
          body: fd,
          signal: controller.signal
        };

        // Add auth header if logged in
        if (auth.token) {
          fetchOptions.headers = { "Authorization": `Bearer ${auth.token}` };
        }

        const res = await fetch("/api/generate", fetchOptions);

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch { data = { ok:false, error: text }; }

        if (!res.ok) {
          const msg = data?.error || data?.detail || `Request failed (${res.status})`;
          throw new Error(msg);
        }

        state.result = data;
        renderOutputs();
        showToast("Done" + (auth.isLoggedIn() ? " (saved to history)" : ""));
      } catch (e) {
        if (e?.name === "AbortError") {
          showToast("Canceled");
        } else {
          showToast(e?.message || "Request error");
          console.error(e);
        }
      } finally {
        state.aborter = null;
        setLoading(false);
      }
    }

    function clearAll() {
      if (state.loading) return;
      state.files = [];
      state.result = null;
      $("hint").value = "";
      updateFilesUI();
      renderOutputs();
      showToast("Cleared");
    }

    // --- Initialization ---
    async function init() {
      // Try to fetch user if token exists
      if (auth.token) {
        await auth.fetchMe();
      }

      // Initial render
      renderPage();

      // Navigation listeners
      document.querySelectorAll("#marketplaceTabs .tab").forEach(a => {
        a.addEventListener("click", (ev) => {
          ev.preventDefault();
          const mode = a.dataset.mode;
          history.pushState({}, "", modeToRoute(mode));
          setMode(mode);
        });
      });

      // Auth page links
      document.querySelectorAll(".auth-card a, #loginLink").forEach(a => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          navigateTo(a.getAttribute("href"));
        });
      });

      window.addEventListener("popstate", () => {
        renderPage();
      });

      // Auth forms
      $("loginForm").addEventListener("submit", handleLogin);
      $("registerForm").addEventListener("submit", handleRegister);
      $("btnLogout").addEventListener("click", () => auth.logout());

      // Click on username to go to history
      $("userEmail").addEventListener("click", () => navigateTo("/dashboard"));

      // Dashboard
      $("btnNewGeneration").addEventListener("click", () => navigateTo("/olx"));
      $("btnPrevPage").addEventListener("click", () => {
        if (state.historyPage > 1) {
          state.historyPage--;
          loadHistory();
        }
      });
      $("btnNextPage").addEventListener("click", () => {
        const totalPages = Math.ceil(state.historyTotal / state.historyLimit);
        if (state.historyPage < totalPages) {
          state.historyPage++;
          loadHistory();
        }
      });

      // Modal
      $("modalClose").addEventListener("click", closeHistoryModal);
      $("historyModal").addEventListener("click", (e) => {
        if (e.target === $("historyModal")) closeHistoryModal();
      });

      // Generator
      $("btnPick").addEventListener("click", () => {
        if (state.loading) return;
        $("fileInput").click();
      });

      $("fileInput").addEventListener("change", (e) => {
        addFiles(e.target.files);
        e.target.value = "";
      });

      const drop = $("drop");
      drop.addEventListener("dragenter", (e) => { e.preventDefault(); if (!state.loading) drop.classList.add("drag"); });
      drop.addEventListener("dragover", (e) => { e.preventDefault(); if (!state.loading) drop.classList.add("drag"); });
      drop.addEventListener("dragleave", (e) => { e.preventDefault(); drop.classList.remove("drag"); });
      drop.addEventListener("drop", (e) => {
        e.preventDefault();
        drop.classList.remove("drag");
        if (state.loading) return;
        addFiles(e.dataTransfer.files);
      });

      $("btnGen").addEventListener("click", generate);
      $("btnClear").addEventListener("click", clearAll);

      $("btnCancel").addEventListener("click", () => {
        if (state.aborter) state.aborter.abort();
      });

      $("copyUniversal").addEventListener("click", () => {
        copyText($("universalOut").textContent || "{}");
      });

      $("copyListing").addEventListener("click", () => {
        const listings = state.result?.listings || {};
        const v = listings[state.mode] || {};
        copyText(JSON.stringify(v, null, 2));
      });

      // Theme toggle
      $("themeToggle").addEventListener("click", () => {
        theme.toggle();
      });

      updateFilesUI();
      renderOutputs();
    }

    init();
  </script>
</body>
</html>
